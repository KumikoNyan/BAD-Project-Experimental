{% extends "CLEAR/base.html" %}
{% load static %}

<head>
    <link rel="stylesheet" type="text/css" href="{% static 'stylesheet3.css' %}">
    <script src="{% static 'js/styling.js' %}"></script>



</head>

{% block content %}
<div class="row pl-3 pt-3 pr-3" style="height:700px;">
    <div class="card main-card">
        <div class="table-responsive card"
            style="overflow-y: scroll; border-radius: 15px; box-shadow: none; height: 90%; margin-bottom: 13px;">
            <table class="table table-hover table-striped" style="border-radius: 40px;">
                <thead style="background-color: #3f3e3e; color: #ffffff;">
                    <th scope="col"> Product # </th>
                    <th scope="col"> Name</th>
                    <th scope="col"> Stock</th>
                    <th scope="col"> Cost </th>
                    <th scope="col"></th>
                </thead>
                <tbody>
                    {% for product_data in product_material_list %}
                    <!-- check views to see full breakdown of product_data -->
                    <tr style="height: 75px;">
                        <td>{{ product_data.product.pk}}</td>
                        <td>{{ product_data.product.name }}</td>
                        <td>{{ product_data.product.stock }}</td>
                        <td>{{ product_data.product.cost }}</td>
                        <td>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="toggleModal('editProduct{{product_data.product.pk}}', 'open')"
                                style="border-radius: 30px;">Edit</button>
                        </td>
                    </tr>

                    <!-- modal to edit products -->
                    <div class="modal-container fade-in" id="editProduct{{ product_data.product.pk }}">
                        <div class="modal-content modal-content-product fade-in">
                            <div class="row ml-auto" style="margin-right: 5px; margin-top:0px; margin-bottom:0px;">
                                <span class="close"
                                    onclick="toggleModal('editProduct{{product_data.product.pk}}', 'close')">&times;</span>
                            </div>
                            <form method="POST" action="{% url 'products' %}"> {% csrf_token %}
                                <input type="hidden" name="edit_form" value="1">
                                <div class="row">
                                    <div class="col-3">
                                        <label for="pk">Product ID</label>
                                        <input type="text" class="form-control" name="product_pk" value="{{product_data.product.pk}}" readonly>
                                    </div>
                                    <div class="col-9">
                                        <label for="name">Product Name</label>
                                        <input type="text" class="form-control" id="name" name="name" value="{{product_data.product.name}}">
                                    </div>
                                </div>
                                <div class="row pt-3">
                                    <div class="col-8">
                                        <div class="container" style="height:125px; overflow-x:visible; overflow-y:scroll;">
                                            <div class="row m-0">
                                                <div class="col-4">Textiles:</div>
                                                <div class="col-3">Unit</div>
                                                <div class="col-3">Quantity</div>
                                                <div class="col-1"></div>
                                            </div>
                                            <div class="productTextileContainer" pk="{{product_data.product.pk}}">
                                                {% for textile in product_data.textiles %}
                                                <div class="row align-items-center mt-2" id="{{product_data.product.pk}}productTextile_row{{forloop.counter}}">
                                                    <div class="col-4">
                                                        <select class="product_textile input-select" id="{{product_data.product.pk}}product_textile{{forloop.counter}}">
                                                            <option value="delete">None</option>
                                                            {% for z in textiles %}
                                                            <option value="{{z.material_key.material_key}}" {% if z.material_key.material_key == textile.textile.material_key.material_key %} selected {% endif %}>{{z.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-3">
                                                        <input type="text" class="unit form-control" name="textile_unit1" value="{{textile.unit}}" readonly>
                                                    </div>
                                                    <div class="col-3">
                                                        <button type="button" class="editTextile_btn btn btn-outline-secondary" style="border-radius: 30px; width:85%;" data-modal="{{product_data.product.pk}}editTextile1" data-modal-action="open">Edit</button>
                                                    </div>
                                                    <div class="col-1">
                                                        <button type="button" class="btn dark-button delete-productMaterial"
                                                            data-select-element-id="{{product_data.product.pk}}product_textile1" data-row-id="{{product_data.product.pk}}productTextile_row1"> &times
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- modal to edit a textile's quantity -->
                                                <div class="modal-overlap-container fade-in" id="{{product_data.product.pk}}editTextile{{forloop.counter}}">
                                                    <div class="modal-overlap-content" style="width:45%">
                                                        <div class="container-fluid">
                                                            <div class="row">
                                                                <div class="col-8">
                                                                    <h2> Edit Textile Quantity</h2>
                                                                </div>
                                                                <div class="col text-right">
                                                                    <span class="close closeTextile" data-modal="{{product_data.product.pk}}editTextile{{forloop.counter}}" data-modal-action="close">&times;</span>
                                                                </div>
                                                            </div>
                                                            <div class="row ml-2 mt-4">
                                                                <div class="col-4">
                                                                    Component
                                                                </div>
                                                                <div class="col-2">
                                                                    Height:
                                                                </div>
                                                                <div class="col-2">
                                                                    Width:
                                                                </div>
                                                                <div class="col-2">
                                                                    Qty:
                                                                </div>
                                                                <div class="col-1">
                                                                </div>
                                                            </div>
                                                            <div class="row ml-2 mt-2" id="edit_productComponent_row_temp{{forloop.counter}}" style="display:none;">
                                                                <div class="col-4">
                                                                    <input type="text" class="form-control" id="component_name_temp" name="">
                                                                </div>
                                                                <div class="col-2">
                                                                    <input type="number" class="form-control" id="height_temp" name="">
                                                                </div>
                                                                <div class="col-2">
                                                                    <input type="number" class="form-control" id="width_temp" name="">
                                                                </div>
                                                                <div class="col-2">
                                                                    <input type="number" class="form-control" id="quantity_temp" name="">
                                                                </div>
                                                                <div class="col-1">
                                                                    <button type="button" class="btn dark-button delete-component" data-row-id=""> &times </button>
                                                                </div>
                                                            </div>
                                                            <div class="row justify-content-center mt-3">
                                                                <button type="button" class="btn dark-button x-button addComponent_edit" data-textile-id="{{forloop.counter}}" data-product-id="{{product_data.product.pk}}">Add Row</button>
                                                            </div>
                                                            <div class="row text-center" style="margin-top: 30px;">
                                                                <div class="col">
                                                                    <button type="button" class="btn dark-button closeTextile"
                                                                    data-modal="{{product_data.product.pk}}editTextile{{forloop.counter}}" data-modal-action="close"> Continue Editing </button>
                                                                </div>
                                                                <div class="col">
                                                                    <button type="submit" class="btn dark-button confirm-button"> Confirm </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {% endfor %}
                                            </div>
                                            <button type="button" class="btn dark-button x-button mt-4" id="addTextile_edit" data-product-id="{{product_data.product.pk}}">Add Row</button>
                                        </div>
                                        <div class="row" style="margin: 25px 0px 25px 0px"></div>
                                        <hr>
                                        <div class="row" style="margin: 25px 0px 25px 0px"></div> 
                                        <div class="container" style="height:125px; overflow-x:visible; overflow-y:scroll;">
                                            <div class="row m-0">
                                                <div class="col-4">Accessories:</div>
                                                <div class="col-3">Unit</div>
                                                <div class="col-3">Quantity</div>
                                                <div class="col-1"></div>
                                            </div>
                                            {% for accessory in product_data.accessories %}
                                            <div class="row align-items-center mt-2" id="{{product_data.product.pk}}productAccessory_row1">
                                                <div class="col-4">
                                                    <select class="input-select" id="{{product_data.product.pk}}product_accessory1" name="{{product_data.product.pk}}product_accessory1">
                                                        <option value="delete">None</option>
                                                        {% for z in accessories %}
                                                        <option value="{{z.material_key.material_key}}">{{z.name}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-3">
                                                    <input type="text" class="form-control" id="{{product_data.product.pk}}accessory_unit1" name="{{product_data.product.pk}}accessory_unit1" placeholder="Unit" readonly>
                                                </div>
                                                <div class="col-3">
                                                    <input type="number" class="form-control" id="{{product_data.product.pk}}accessory_quantity1" name="{{product_data.product.pk}}accessory_quantity1"
                                                        placeholder="Quantity">
                                                </div>
                                                <div class="col-1">
                                                    <button type="button" class="btn dark-button delete-productMaterial"
                                                        data-select-element-id="{{product_data.product.pk}}product_accessory1" data-row-id="{{product_data.product.pk}}productAccessory_row1"> &times
                                                    </button>
                                                </div>
                                            </div>
                                            {% endfor %}
                                            <button type="button" class="btn dark-button x-button mt-4" id="addAccessory_edit" data-product-id="{{product_data.product.pk}}">Add Row</button>
                                        </div>
                                    </div>
                                    
                                    <div class="col-4 mt-3">
                                        <label for="stock">Product Margin</label>
                                        <input type="number" class="form-control" id="prod_margin" name="prod_margin" value="{{product_data.product.prod_margin}}">
                                        <label class="mt-3" for="cost">Stock</label>
                                        <input type="number" class="form-control" id="stock" name="stock" value="{{product_data.product.stock}}">
                                        <label class="mt-3" for="stock">Labor Time</label>
                                        <input type="number" class="form-control" id="labor_time" name="labor_time" value="{{product_data.product.labor_time}}">
                                        <label class="mt-3" for="stock">Miscellaneous Margin</label>
                                        <input type="number" class="form-control" id="misc_margin" name="misc_margin" value="{{product_data.product.misc_margin}}">
                                    </div>
                                </div>
                                <div class="row" style="margin: 20px 5px 12px 5px;">
                                    <div class="col-4 order-2 ml-auto text-right">
                                        <button type="button" class="btn dark-button" onclick="toggleModal('confirmAddProduct', 'open')">
                                            Save Edits </button>
                                    </div>
                                </div>
                    
                    

                                    <!-- modal to confirm edits to product -->
                                    <div class="modal-overlap-container fade-in"
                                        id="confirmEditProduct{{product_data.product.pk}}">
                                        <div class="modal-overlap-content fade-in">
                                            <div class="container-fluid">
                                                <div class="row">
                                                    <div class="col text-right">
                                                        <span class="close"
                                                            onclick="toggleModal('confirmEditProduct{{product_data.product.pk}}', 'close')">&times;</span>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col text-center">
                                                        <h2> Confirm Edits? </h2>
                                                    </div>
                                                </div>
                                                <div class="row text-center" style="margin-top: 15px;">
                                                    <div class="col">
                                                        <button type="button" class="btn dark-button"
                                                            onclick="toggleModal('confirmEditProduct{{product_data.product.pk}}', 'close')">
                                                            Continue Editing </button>
                                                    </div>
                                                    <div class="col">
                                                        <button type="submit" class="btn dark-button confirm-button">
                                                            Confirm
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </form>
                            <div class="col-4 order-1 mr-auto text-left">
                                <button type="button" class="btn dark-button"
                                    onclick="toggleModal('confirmDeleteProduct{{product_data.product.pk}}', 'open')">
                                    Delete Product
                                </button>
                            </div>

                            <!-- modal to confirm deletion of product -->
                            <div class="modal-overlap-container fade-in"
                                id="confirmDeleteProduct{{product_data.product.pk}}">
                                <form method="POST" action="{% url 'products' %}"> {% csrf_token %}
                                    <div class="modal-overlap-content fade-in">
                                        <input type="hidden" name="delete_form" value="1">
                                        <input type="hidden" name="productMaterial_pk"
                                            value="{{product_data.product.pk}}">
                                        <div class="container-fluid">
                                            <div class="row">
                                                <div class="col text-right">
                                                    <span class="close"
                                                        onclick="toggleModal('confirmDeleteProduct{{product_data.product.pk}}', 'close')">&times;</span>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col text-center">
                                                    <h2> Delete Product? </h2>
                                                </div>
                                            </div>
                                            <div class="row text-center" style="margin-top: 15px;">
                                                <div class="col">
                                                    <button type="button" class="btn dark-button"
                                                        onclick="toggleModal('confirmDeleteProduct{{product_data.product.pk}}', 'close')">
                                                        Continue Editing </button>
                                                </div>
                                                <div class="col">
                                                    <button type="submit" class="btn dark-button delete-button"> Confirm
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
        </div>
        </tbody>
        </table>
        </table>
    </div>
    <div class="row ml-auto pr-3">
        <button type="button" class="btn light-button" onclick="toggleModal('addProduct', 'open')"
            style="margin-top: -5%;">
            Add Product</button>
    </div>
</div>


<!-- modal to add product to table -->

<div class="modal-container fade-in" id="addProduct">
    <div class="modal-content modal-content-product fade-in">
        <div class="row ml-auto" style="margin-right: 5px; margin-top:0px; margin-bottom:0px;">
            <span class="close" onclick="toggleModal('addProduct', 'close')">&times;</span>
        </div>
        <form method="POST" action="{% url 'products' %}"> {% csrf_token %}
            <input type="hidden" name="add_form" value="1">
            <div class="row">
                <div class="col-3">
                    <label for="pk">Product ID</label>
                    <input type="text" class="form-control" placeholder="Product #" readonly>
                </div>
                <div class="col-9">
                    <label for="name">Product Name</label>
                    <input type="text" class="product_name form-control" name="name" placeholder="Product Name">
                </div>
            </div>
            <div class="row pt-3">
                <div class="col-8">
                    <div class="container" style="height:125px; overflow-x:visible; overflow-y:scroll;">
                        <div class="row m-0">
                            <div class="col-4">Textiles:</div>
                            <div class="col-3">Unit</div>
                            <div class="col-3">Quantity</div>
                            <div class="col-1"></div>
                        </div>
                        <div class="productTextileContainer">
                            <div class="productTextile_row row align-items-center mt-2" id="productTextile_row1">
                                <div class="col-4">
                                    <select class="product_textile input-select" name="product_textile">
                                        <option value="delete">None</option>
                                        {% for z in textiles %}
                                        <option value="{{z.material_key.material_key}}">{{z.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-3">
                                    <input type="text" class="unit form-control" name="textile_unit1" placeholder="Unit" readonly>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="editTextile_btn btn btn-outline-secondary" style="border-radius: 30px; width:85%;" 
                                    data-modal="editTextile1" data-modal-action="open">Edit</button>
                                </div>
                                <div class="col-1">
                                    <button type="button" class="btn dark-button delete-productMaterial"
                                     data-row-id="productTextile_row1"> &times
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn dark-button x-button mt-4" id="addTextile_add">Add Row</button>
                    </div>
                    <div class="row" style="margin: 25px 0px 25px 0px"></div>
                    <hr>
                    <div class="row" style="margin: 25px 0px 25px 0px"></div> 
                    <div class="container" style="height:125px; overflow-x:visible; overflow-y:scroll;">
                        <div class="row m-0">
                            <div class="col-4">Accessories:</div>
                            <div class="col-3">Unit</div>
                            <div class="col-3">Quantity</div>
                            <div class="col-1"></div>
                        </div>
                        <div class="productAccessoryContainer">
                            <div class="productAccessory_row row align-items-center mt-2" id="productAccessory_row1">
                                <div class="col-4">
                                    <select class="product_accessory input-select" name="product_accessory">
                                        <option value="delete">None</option>
                                        {% for z in accessories %}
                                        <option value="{{z.material_key.material_key}}">{{z.name}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-3">
                                    <input type="text" class="unit form-control" name="accessory_unit" placeholder="Unit" readonly>
                                </div>
                                <div class="col-3">
                                    <input type="number" class="quantity form-control"  name="accessory_quantity" placeholder="Quantity">
                                </div>
                                <div class="col-1">
                                    <button type="button" class="btn dark-button delete-productMaterial" data-row-id="productAccessory_row1"> &times
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn dark-button x-button mt-4" id="addAccessory_add">Add Row</button>
                    </div>
                </div>
                
                <div class="col-4 mt-3">
                    <label for="stock">Product Margin</label>
                    <input type="number" class="product_margin form-control" id="prod_margin" name="prod_margin" placeholder="Product Margin">
                    <label class="mt-3" for="cost">Stock</label>
                    <input type="number" class="product_stock form-control" id="stock" name="stock" placeholder="Stock">
                    <label class="mt-3" for="stock">Labor Time</label>
                    <input type="number" class="product_labor form-control" id="labor_time" name="labor_time" placeholder="Labor Time">
                    <label class="mt-3" for="stock">Miscellaneous Margin</label>
                    <input type="number" class="product_misc form-control" id="misc_margin" name="misc_margin" value="50">
                </div>
            </div>
            <div class="row" style="margin: 20px 5px 12px 5px;">
                <div class="col-4 order-2 ml-auto text-right">
                    <button type="button" class="btn dark-button" onclick="toggleModal('confirmAddProduct', 'open')">
                        Save Edits </button>
                </div>
            </div>

            <div class="editTextileContainer">
                <div class="modal-overlap-container fade-in" id="editTextile1">
                    <div class="modal-overlap-content" style="width:45%">
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-8">
                                    <h2> Edit Textile Quantity</h2>
                                </div>
                                <div class="col text-right">
                                    <span class="close closeTextile" data-modal="editTextile1" data-modal-action="close">&times;</span>
                                </div>
                            </div>
                            <div class="row ml-2 mt-4">
                                <div class="col-4">
                                    Component
                                </div>
                                <div class="col-2">
                                    Height:
                                </div>
                                <div class="col-2">
                                    Width:
                                </div>
                                <div class="col-2">
                                    Qty:
                                </div>
                                <div class="col-1">
                                </div>
                            </div>
                            <div class="productComponentContainer" id="productComponentContainer1">
                            </div>
                            <div class="row justify-content-center mt-3">
                                <button type="button" class="btn dark-button x-button addComponent_add" data-textile-id="1" data-counter="1">Add Row</button>
                            </div>
                            <div class="row text-center" style="margin-top: 30px;">
                                <div class="col">
                                    <button type="button" class="btn dark-button closeTextile"
                                    data-modal="editTextile1" data-modal-action="close"> Continue Editing </button>
                                </div>
                                <div class="col">
                                    <button type="button" class="btn dark-button confirm-button"> Confirm </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- mmodal to confirm addition of product -->
            <div class="modal-overlap-container fade-in" id="confirmAddProduct">
                <div class="modal-overlap-content">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col text-right">
                                <span class="close" onclick="toggleModal('confirmAddProduct', 'close')">&times;</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col text-center">
                                <h2> Add Product? </h2>
                            </div>
                        </div>
                        <div class="row text-center" style="margin-top: 15px;">
                            <div class="col">
                                <button type="button" class="btn dark-button"
                                    onclick="toggleModal('confirmAddProduct', 'close')"> Continue Editing </button>
                            </div>
                            <div class="col">
                                <button type="button" class="btn dark-button confirm-button submit-btn"> Confirm </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>



</div>
</div>
</div>

<!-- templates -->
<div class="productComponent_row row ml-2 mt-2" id="productComponent_row_temp" style="display:none;">
    <div class="col-4">
        <input type="text" class="component_name form-control" name="">
    </div>
    <div class="col-2">
        <input type="number" class="height form-control" name="">
    </div>
    <div class="col-2">
        <input type="number" class="width form-control" name="">
    </div>
    <div class="col-2">
        <input type="number" class="quantity form-control" name="">
    </div>
    <div class="col-1">
        <button type="button" class="btn dark-button delete-component" data-row-id=""> &times </button>
    </div>
</div>

<div class="productTextile_row row align-items-center mt-2" id="productTextile_row_temp" style="display:none;">
    <div class="col-4">
        <select class="product_textile input-select" name="product_textile">
            <option value="delete">None</option>
            {% for z in textiles %}
            <option value="{{z.material_key.material_key}}">{{z.name}}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-3">
        <input type="text" class="unit form-control" name="textile_unit" placeholder="Unit" readonly>
    </div>
    <div class="col-3">
        <button type="button" class="editTextile_btn btn btn-outline-secondary" style="border-radius: 30px; width:85%;" 
        data-modal="editTextile1" data-modal-action="open">Edit</button>
    </div>
    <div class="col-1">
        <button type="button" class="btn dark-button delete-productMaterial"
         data-row-id="productTextile_row1"> &times
        </button>
    </div>
</div>

<div class="row align-items-center mt-2" id="productAccessory_row_temp" style="display:none;">
    <div class="col-4">
        <select class="product_accessory input-select" name="product_accessory">
            <option value="delete">None</option>
            {% for z in accessories %}
            <option value="{{z.material_key.material_key}}">{{z.name}}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-3">
        <input type="text" class="unit form-control" name="accessory_unit" placeholder="Unit" readonly>
    </div>
    <div class="col-3">
        <input type="number" class="quantity form-control"  name="accessory_quantity"
            placeholder="Quantity">
    </div>
    <div class="col-1">
        <button type="button" class="btn dark-button delete-productMaterial" data-row-id="productAccessory_row1"> &times
        </button>
    </div>
</div>

<script>

    $(document).ready(function () {
        let rowCounter_add_accessory = 1;
        let rowCounter_add_textile = 1;
        const addTextile_parent = $('.productTextileContainer');
        const textile_template = $('#productTextile_row_temp');
        const addAccessory_parent = $('.productAccessoryContainer');
        const accessory_template = $('#productAccessory_row_temp');
        const component_template = $('#productComponent_row_temp');
        const textileModal_parent = $('.editTextileContainer');

        function addAccessory_add() {
            rowCounter_add_accessory++;

            let newRow = accessory_template.clone();
            newRow.attr('id', 'productAccessory_row' + rowCounter_add_accessory);
            newRow.find('.product_accessory').val('delete');
            newRow.find('.unit').val('');
            newRow.find('.quantity').val('');

            newRow.find('.delete-productMaterial').attr('data-row-id', 'productAccessory_row' + rowCounter_add_accessory)

            newRow.show()
            addAccessory_parent.append(newRow);
        }

        function addTextile_add() {
            rowCounter_add_textile++;

            let newRow = textile_template.clone();
            newRow.attr('id', 'productTextile_row' + rowCounter_add_textile);
            newRow.find('.product_textile').val('delete');
            newRow.find('.unit').val('');
            newRow.find('.editTextile_btn').attr('data-modal', 'editTextile' + rowCounter_add_textile)

            newRow.find('.delete-productMaterial').attr('data-row-id', 'productTextile_row' + rowCounter_add_textile)

            newRow.show()
            addTextile_parent.append(newRow);

            let newModal = $('#editTextile1').clone();
            newModal.attr('id', 'editTextile' + rowCounter_add_textile);
            newModal.find('[id^="productComponent_row_temp"]').attr('id', 'productComponent_row' + rowCounter_add_textile);
            newModal.find('.addComponent_add').attr('data-textile-id', rowCounter_add_textile);

            newModal.find('.closeTextile').each(function(index) {
                $(this).attr('data-modal', 'editTextile' + rowCounter_add_textile);
            });

            let component_container = newModal.find('.productComponentContainer')
            component_container.attr('id', 'productComponentContainer' + rowCounter_add_textile)
            component_container.empty()

            $('#editTextile' + (rowCounter_add_textile - 1)).after(newModal.show());

        }

        function addComponent_add(textileId, counter) {
            console.log("before:" + counter);
            let parent = $('#productComponentContainer' + textileId);

            newRow = component_template.clone()
            newRow.attr('id', 'productComponent_row' + textileId + '_' + counter);
            newRow.find('.component_name').val('');
            newRow.find('.height').val('');
            newRow.find('.width').val('');
            newRow.find('.quantity').val('');

            newRow.find('.delete-component').attr('data-row-id', 'productComponent_row' + textileId + '_' + counter);

            newRow.show();
            parent.append(newRow)

            let button = $('.addComponent_add[data-textile-id="' + textileId + '"]');

            counter++;

            console.log('before button:' + button.attr('data-counter'));
            button.data('counter', counter);
            console.log('after button:' + button.attr('data-counter'));

        }

        

        $('#addAccessory_add').on('click', addAccessory_add);

        $('#addTextile_add').on('click', addTextile_add); 

        $('#addProduct').on('click', '.addComponent_add', function () {
            let textileId = $(this).data('textile-id');
            let counter = $(this).data('counter');
            console.log('event:' + counter)
            addComponent_add(textileId, counter);
        });
        
        $(addTextile_parent).on('click', '.delete-productMaterial', function () {
            let rowId = $(this).data('row-id');
            console.log(rowId)

            $('#' + rowId).remove();
        });

        $(addAccessory_parent).on('click', '.delete-productMaterial', function () {
            let rowId = $(this).data('row-id');
            console.log(rowId)

            $('#' + rowId).remove();
        });

        $(document).on('click', '.delete-component', function () {
            let rowId = $(this).data('row-id');
            console.log(rowId)

            $('#' + rowId).remove();
        });

        $('#addProduct').on('click', '.editTextile_btn', function () {
            let modalId = $(this).data('modal');
            let action = $(this).data('modal-action');

            console.log(modalId)

            toggleModal(modalId, action);
        });

        $('#addProduct').on('click', '.closeTextile', function () {
            let modalId = $(this).data('modal');
            let action = $(this).data('modal-action');

            console.log(modalId)

            toggleModal(modalId, action);
        });

        $(document).on('click', '.addRowEditProduct', function () {
            var productPK = $(this).data('product-pk');
            var rowCount = $('[id^="' + productPK + '_productMaterial_row"]').length;

            // console.log('rowcount', rowCount)

            addRow_editProduct(rowCount, productPK);
        });

        $(".submit-btn").click(function() {

            // pack rows
            let textile_data = [];
            let accessory_data = [];
            const product_parent = $('#addProduct')

            $.each($(addTextile_parent).find('.productTextile_row'), function(counter, row){
                let rowId = $(row).attr('id');
                let rowNumber = rowId.match(/\d+$/)[0];
                let componentsData = [];

                $('#productComponentContainer' + rowNumber).find('.productComponent_row').each(function() {
                    let component = {
                        'component_name': $(this).find('.component_name').val(),
                        'height': $(this).find('.height').val(),
                        'width': $(this).find('.width').val(),
                        'quantity': $(this).find('.quantity').val(),
                    };
                    componentsData.push(component);
                });


                temp = {
                    'textile_id': $(row).find(".product_textile").val(),
                    'components': componentsData
                }
                textile_data.push(temp);
            });

            $.each($(addAccessory_parent).find('.productAccessory_row'), function(counter, row){
                let rowId = $(row).attr('id');
                let rowNumber = rowId.match(/\d+$/)[0];


                temp = {
                    'accessory_id': $(row).find(".product_accessory").val(),
                    'quantity': $(row).find(".quantity").val(),
                }
                accessory_data.push(temp);
                console.log(accessory_data);
            });

            submit_data = {
                'name': product_parent.find('.product_name').val(),
                'margin': product_parent.find('.product_margin').val(),
                'stock': product_parent.find('.product_stock').val(),
                'labor': product_parent.find('.product_labor').val(),
                'misc': product_parent.find('.product_misc').val(),
                'textile_data': JSON.stringify(textile_data),
                'accessory_data': JSON.stringify(accessory_data),
                "csrfmiddlewaretoken": $("[name=csrfmiddlewaretoken]").val(),
                'add_form': 'add_form'
            }
            console.log(submit_data)

            $.ajax({
                method: "post",
                data: submit_data,
                success: function(data){
                    console.log(data["status"])
                    if (data["status"]){
                        // redirect to returned url
                        window.location = data["url"];
                    } else{
                        // controlled error, display message
                        alert(data["msg"]);
                    }
                },
                error: function(xhr, textStatus, errorThrown){
                    // Basic `xhr.status` Key
                    // 0    = Server didn't Reply (Server Down)
                    // 400  = Bad Request         (Syntax Error)
                    // 403  = Forbidden           (Login Token Expired)
                    // 403  = Not Found           (Invalid Url)
                    // 500  = Server Error        (Django Crash)
                    alert("something broke")  // uncontrolled error
                }
            });

        });
        

    });


</script>
{% endblock %}